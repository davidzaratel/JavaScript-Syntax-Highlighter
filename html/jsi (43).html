<!DOCTYPE html>
    <html>
    <head>
      <title> Javascript Script Highlighter</title>
      <link rel='stylesheet' href='../css/styles.css'>
    </head>
    <body>
    <h1>Javascript script highlighter</h1>
    <h3> By: David Zarate Lopez A01329795</h3>
    <br>
    <pre><code><span class="reserved">import</span><span> </span><span class="identifier">passport</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'passport'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="identifier">dedent</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'dedent'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">check</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'express-validator'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">isEmail</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'validator'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="identifier">jwt</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'jsonwebtoken'</span><span class="signs">;</span><br><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">jwtSecret</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'../../../../config/secrets'</span><span class="signs">;</span><br><br><span class="reserved">import</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span class="identifier">createPassportCallbackAuthenticator</span><span class="signs">,</span><br><span> </span><span> </span><span class="identifier">devSaveResponseAuthCookies</span><span class="signs">,</span><br><span> </span><span> </span><span class="identifier">devLoginRedirect</span><br><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'../component-passport'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">ifUserRedirectTo</span><span class="signs">,</span><span> </span><span class="identifier">ifNoUserRedirectHome</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'../utils/middleware'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">wrapHandledError</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'../utils/create-handled-error.js'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">removeCookies</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'../utils/getSetAccessToken'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">decodeEmail</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'../../common/utils'</span><span class="signs">;</span><br><span class="reserved">import</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">getRedirectParams</span><span> </span><span class="signs">}</span><span> </span><span class="identifier">from</span><span> </span><span class="string">'../utils/redirection'</span><span class="signs">;</span><br><br><span class="reserved">const</span><span> </span><span class="identifier">isSignUpDisabled</span><span> </span><span class="signs">=</span><span> </span><span class="signs">!</span><span class="signs">!</span><span class="identifier">process</span><span class="signs">.</span><span class="identifier">env</span><span class="signs">.</span><span class="identifier">DISABLE</span><span class="identifier">_SIGNUP</span><span class="signs">;</span><br><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="identifier">isSignUpDisabled</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span class="identifier">console</span><span class="signs">.</span><span class="reserved">log</span><span class="signs">(</span><span class="string">'fcc:boot:auth - Sign up is disabled'</span><span class="signs">)</span><span class="signs">;</span><br><span class="signs">}</span><br><br><span class="reserved">const</span><span> </span><span class="identifier">passwordlessGetValidators</span><span> </span><span class="signs">=</span><span> </span><span class="signs">[</span><br><span> </span><span> </span><span class="identifier">check</span><span class="signs">(</span><span class="string">'email'</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">isBase64</span><span class="signs">(</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">withMessage</span><span class="signs">(</span><span class="string">'Email should be a base64 encoded string.'</span><span class="signs">)</span><span class="signs">,</span><br><span> </span><span> </span><span class="identifier">check</span><span class="signs">(</span><span class="string">'token'</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">exists</span><span class="signs">(</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">withMessage</span><span class="signs">(</span><span class="string">'Token should exist.'</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="comment">// based on strongloop/loopback/common/models/access-token.js#L15
</span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">isLength</span><span class="signs">(</span><span class="signs">{</span><span> </span><span class="identifier">min</span><span class="signs">:</span><span> </span><span class="num">64</span><span class="signs">,</span><span> </span><span class="identifier">max</span><span class="signs">:</span><span> </span><span class="num">64</span><span> </span><span class="signs">}</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">withMessage</span><span class="signs">(</span><span class="string">'Token is not the right length.'</span><span class="signs">)</span><br><span class="signs">]</span><span class="signs">;</span><br><br><span class="identifier">module</span><span class="signs">.</span><span class="identifier">exports</span><span> </span><span class="signs">=</span><span> </span><span class="reserved">function</span><span> </span><span class="identifier">enableAuthentication</span><span class="signs">(</span><span class="identifier">app</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span class="comment">// enable loopback access control authentication. see:
</span><span> </span><span> </span><span class="comment">// loopback.io/doc/en/lb2/Authentication-authorization-and-permissions.html
</span><span> </span><span> </span><span class="identifier">app</span><span class="signs">.</span><span class="identifier">enableAuth</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="identifier">ifUserRedirect</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">ifUserRedirectTo</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="identifier">ifNoUserRedirect</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">ifNoUserRedirectHome</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="identifier">devSaveAuthCookies</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">devSaveResponseAuthCookies</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="identifier">devLoginSuccessRedirect</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">devLoginRedirect</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="identifier">api</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">app</span><span class="signs">.</span><span class="identifier">loopback</span><span class="signs">.</span><span class="identifier">Router</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><br><span> </span><span> </span><span class="comment">// Use a local mock strategy for signing in if we are in dev mode.
</span><span> </span><span> </span><span class="comment">// Otherwise we use auth0 login. We use a string for 'true' because values
</span><span> </span><span> </span><span class="comment">// set in the env file will always be strings and never boolean.
</span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="identifier">process</span><span class="signs">.</span><span class="identifier">env</span><span class="signs">.</span><span class="identifier">LOCAL</span><span class="identifier">_MOCK</span><span class="identifier">_AUTH</span><span> </span><span class="signs">=</span><span class="signs">=</span><span class="signs">=</span><span> </span><span class="string">'true'</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">api</span><span class="signs">.</span><span class="identifier">get</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="string">'/signin'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">passport</span><span class="signs">.</span><span class="identifier">authenticate</span><span class="signs">(</span><span class="string">'devlogin'</span><span class="signs">)</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">devSaveAuthCookies</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">devLoginSuccessRedirect</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="signs">}</span><span> </span><span class="reserved">else</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">api</span><span class="signs">.</span><span class="identifier">get</span><span class="signs">(</span><span class="string">'/signin'</span><span class="signs">,</span><span> </span><span class="identifier">ifUserRedirect</span><span class="signs">,</span><span> </span><span class="signs">(</span><span class="identifier">req</span><span class="signs">,</span><span> </span><span class="identifier">res</span><span class="signs">,</span><span> </span><span class="identifier">next</span><span class="signs">)</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">returnTo</span><span class="signs">,</span><span> </span><span class="identifier">origin</span><span class="signs">,</span><span> </span><span class="identifier">pathPrefix</span><span> </span><span class="signs">}</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">getRedirectParams</span><span class="signs">(</span><span class="identifier">req</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="identifier">state</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">jwt</span><span class="signs">.</span><span class="identifier">sign</span><span class="signs">(</span><span class="signs">{</span><span> </span><span class="identifier">returnTo</span><span class="signs">,</span><span> </span><span class="identifier">origin</span><span class="signs">,</span><span> </span><span class="identifier">pathPrefix</span><span> </span><span class="signs">}</span><span class="signs">,</span><span> </span><span class="identifier">jwtSecret</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="identifier">passport</span><span class="signs">.</span><span class="identifier">authenticate</span><span class="signs">(</span><span class="string">'auth0-login'</span><span class="signs">,</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">state</span><span> </span><span class="signs">}</span><span class="signs">)</span><span class="signs">(</span><span class="identifier">req</span><span class="signs">,</span><span> </span><span class="identifier">res</span><span class="signs">,</span><span> </span><span class="identifier">next</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><span class="signs">;</span><br><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">api</span><span class="signs">.</span><span class="identifier">get</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="string">'/auth/auth0/callback'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">createPassportCallbackAuthenticator</span><span class="signs">(</span><span class="string">'auth0-login'</span><span class="signs">,</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">provider</span><span class="signs">:</span><span> </span><span class="string">'auth0'</span><span> </span><span class="signs">}</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="signs">}</span><br><br><span> </span><span> </span><span class="identifier">api</span><span class="signs">.</span><span class="identifier">get</span><span class="signs">(</span><span class="string">'/signout'</span><span class="signs">,</span><span> </span><span class="signs">(</span><span class="identifier">req</span><span class="signs">,</span><span> </span><span class="identifier">res</span><span class="signs">)</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">origin</span><span> </span><span class="signs">}</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">getRedirectParams</span><span class="signs">(</span><span class="identifier">req</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">req</span><span class="signs">.</span><span class="identifier">logout</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">req</span><span class="signs">.</span><span class="identifier">session</span><span class="signs">.</span><span class="identifier">destroy</span><span class="signs">(</span><span class="identifier">err</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="identifier">err</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">throw</span><span> </span><span class="identifier">wrapHandledError</span><span class="signs">(</span><span class="reserved">new</span><span> </span><span class="identifier">Error</span><span class="signs">(</span><span class="string">'could not destroy session'</span><span class="signs">)</span><span class="signs">,</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">type</span><span class="signs">:</span><span> </span><span class="string">'info'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">message</span><span class="signs">:</span><span> </span><span class="string">'We could not log you out, please try again in a moment.'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">redirectTo</span><span class="signs">:</span><span> </span><span class="identifier">origin</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">removeCookies</span><span class="signs">(</span><span class="identifier">req</span><span class="signs">,</span><span> </span><span class="identifier">res</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">res</span><span class="signs">.</span><span class="identifier">redirect</span><span class="signs">(</span><span class="identifier">origin</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><span class="signs">;</span><br><br><span> </span><span> </span><span class="identifier">api</span><span class="signs">.</span><span class="identifier">get</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span class="string">'/confirm-email'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">ifNoUserRedirect</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">passwordlessGetValidators</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">createGetPasswordlessAuth</span><span class="signs">(</span><span class="identifier">app</span><span class="signs">)</span><br><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><br><span> </span><span> </span><span class="identifier">app</span><span class="signs">.</span><span class="identifier">use</span><span class="signs">(</span><span class="identifier">api</span><span class="signs">)</span><span class="signs">;</span><br><span class="signs">}</span><span class="signs">;</span><br><br><span class="reserved">const</span><span> </span><span class="identifier">defaultErrorMsg</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">dedent</span><span class="string">`
    Oops, something is not right,
    please request a fresh link to sign in / sign up.
  `</span><span class="signs">;</span><br><br><span class="reserved">function</span><span> </span><span class="identifier">createGetPasswordlessAuth</span><span class="signs">(</span><span class="identifier">app</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span class="identifier">models</span><span class="signs">:</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">AuthToken</span><span class="signs">,</span><span> </span><span class="identifier">User</span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span class="signs">}</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">app</span><span class="signs">;</span><br><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="reserved">function</span><span> </span><span class="identifier">getPasswordlessAuth</span><span class="signs">(</span><span class="identifier">req</span><span class="signs">,</span><span> </span><span class="identifier">res</span><span class="signs">,</span><span> </span><span class="identifier">next</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">query</span><span class="signs">:</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">email</span><span class="signs">:</span><span> </span><span class="identifier">encodedEmail</span><span class="signs">,</span><span> </span><span class="identifier">token</span><span class="signs">:</span><span> </span><span class="identifier">authTokenId</span><span class="signs">,</span><span> </span><span class="identifier">emailChange</span><span> </span><span class="signs">}</span><span> </span><span class="signs">=</span><span> </span><span class="signs">{</span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">req</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">origin</span><span> </span><span class="signs">}</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">getRedirectParams</span><span class="signs">(</span><span class="identifier">req</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="reserved">const</span><span> </span><span class="identifier">email</span><span> </span><span class="signs">=</span><span> </span><span class="identifier">decodeEmail</span><span class="signs">(</span><span class="identifier">encodedEmail</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="signs">!</span><span class="identifier">isEmail</span><span class="signs">(</span><span class="identifier">email</span><span class="signs">)</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="identifier">next</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">wrapHandledError</span><span class="signs">(</span><span class="reserved">new</span><span> </span><span class="identifier">TypeError</span><span class="signs">(</span><span class="string">'decoded email is invalid'</span><span class="signs">)</span><span class="signs">,</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">type</span><span class="signs">:</span><span> </span><span class="string">'info'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">message</span><span class="signs">:</span><span> </span><span class="string">'The email encoded in the link is incorrectly formatted'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">redirectTo</span><span class="signs">:</span><span> </span><span class="string">`${origin}/signin`</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span class="comment">// first find
</span><span> </span><span> </span><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">AuthToken</span><span class="signs">.</span><span class="identifier">findOne</span><span class="identifier">$</span><span class="signs">(</span><span class="signs">{</span><span> </span><span class="identifier">where</span><span class="signs">:</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">id</span><span class="signs">:</span><span> </span><span class="identifier">authTokenId</span><span> </span><span class="signs">}</span><span> </span><span class="signs">}</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">flatMap</span><span class="signs">(</span><span class="identifier">authToken</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="signs">!</span><span class="identifier">authToken</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">throw</span><span> </span><span class="identifier">wrapHandledError</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">new</span><span> </span><span class="identifier">Error</span><span class="signs">(</span><span class="string">`no token found for id: ${authTokenId}`</span><span class="signs">)</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">type</span><span class="signs">:</span><span> </span><span class="string">'info'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">message</span><span class="signs">:</span><span> </span><span class="identifier">defaultErrorMsg</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">redirectTo</span><span class="signs">:</span><span> </span><span class="string">`${origin}/signin`</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="comment">// find user then validate and destroy email validation token
</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="comment">// finally retun user instance
</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="identifier">User</span><span class="signs">.</span><span class="identifier">findOne</span><span class="identifier">$</span><span class="signs">(</span><span class="signs">{</span><span> </span><span class="identifier">where</span><span class="signs">:</span><span> </span><span class="signs">{</span><span> </span><span class="identifier">id</span><span class="signs">:</span><span> </span><span class="identifier">authToken</span><span class="signs">.</span><span class="identifier">userId</span><span> </span><span class="signs">}</span><span> </span><span class="signs">}</span><span class="signs">)</span><span class="signs">.</span><span class="identifier">flatMap</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">user</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="signs">!</span><span class="identifier">user</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">throw</span><span> </span><span class="identifier">wrapHandledError</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">new</span><span> </span><span class="identifier">Error</span><span class="signs">(</span><span class="string">`no user found for token: ${authTokenId}`</span><span class="signs">)</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">type</span><span class="signs">:</span><span> </span><span class="string">'info'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">message</span><span class="signs">:</span><span> </span><span class="identifier">defaultErrorMsg</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">redirectTo</span><span class="signs">:</span><span> </span><span class="string">`${origin}/signin`</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="identifier">user</span><span class="signs">.</span><span class="identifier">email</span><span> </span><span class="signs">!</span><span class="signs">=</span><span class="signs">=</span><span> </span><span class="identifier">email</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="signs">!</span><span class="identifier">emailChange</span><span> </span><span class="signs">|</span><span class="signs">|</span><span> </span><span class="signs">(</span><span class="identifier">emailChange</span><span> </span><span class="signs">&</span><span class="signs">&</span><span> </span><span class="identifier">user</span><span class="signs">.</span><span class="identifier">newEmail</span><span> </span><span class="signs">!</span><span class="signs">=</span><span class="signs">=</span><span> </span><span class="identifier">email</span><span class="signs">)</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">throw</span><span> </span><span class="identifier">wrapHandledError</span><span class="signs">(</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">new</span><span> </span><span class="identifier">Error</span><span class="signs">(</span><span class="string">'user email does not match'</span><span class="signs">)</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">type</span><span class="signs">:</span><span> </span><span class="string">'info'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">message</span><span class="signs">:</span><span> </span><span class="identifier">defaultErrorMsg</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">redirectTo</span><span class="signs">:</span><span> </span><span class="string">`${origin}/signin`</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="identifier">authToken</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">validate</span><span class="identifier">$</span><span class="signs">(</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">map</span><span class="signs">(</span><span class="identifier">isValid</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">if</span><span> </span><span class="signs">(</span><span class="signs">!</span><span class="identifier">isValid</span><span class="signs">)</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">throw</span><span> </span><span class="identifier">wrapHandledError</span><span class="signs">(</span><span class="reserved">new</span><span> </span><span class="identifier">Error</span><span class="signs">(</span><span class="string">'token is invalid'</span><span class="signs">)</span><span class="signs">,</span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">type</span><span class="signs">:</span><span> </span><span class="string">'info'</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">message</span><span class="signs">:</span><span> </span><span class="string">`
                        Looks like the link you clicked has expired,
                        please request a fresh link, to sign in.
                      `</span><span class="signs">,</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">redirectTo</span><span class="signs">:</span><span> </span><span class="string">`${origin}/signin`</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="identifier">authToken</span><span class="signs">.</span><span class="identifier">destroy</span><span class="identifier">$</span><span class="signs">(</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">map</span><span class="signs">(</span><span class="signs">(</span><span class="signs">)</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="identifier">user</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="comment">// at this point token has been validated and destroyed
</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="comment">// update user and log them in
</span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">map</span><span class="signs">(</span><span class="identifier">user</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="identifier">user</span><span class="signs">.</span><span class="identifier">loginByRequest</span><span class="signs">(</span><span class="identifier">req</span><span class="signs">,</span><span> </span><span class="identifier">res</span><span class="signs">)</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="reserved">do</span><span class="signs">(</span><span class="signs">(</span><span class="signs">)</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="identifier">req</span><span class="signs">.</span><span class="identifier">flash</span><span class="signs">(</span><span class="string">'success'</span><span class="signs">,</span><span> </span><span class="string">'flash.signin-success'</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="reserved">return</span><span> </span><span class="identifier">res</span><span class="signs">.</span><span class="identifier">redirectWithFlash</span><span class="signs">(</span><span class="string">`${origin}/learn`</span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">}</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span> </span><span class="signs">.</span><span class="identifier">subscribe</span><span class="signs">(</span><span class="signs">(</span><span class="signs">)</span><span> </span><span class="signs">=</span><span class="signs">></span><span> </span><span class="signs">{</span><span class="signs">}</span><span class="signs">,</span><span> </span><span class="identifier">next</span><span class="signs">)</span><br><span> </span><span> </span><span> </span><span> </span><span class="signs">)</span><span class="signs">;</span><br><span> </span><span> </span><span class="signs">}</span><span class="signs">;</span><br><span class="signs">}</span><br></code></pre>
    </body>
    </html>